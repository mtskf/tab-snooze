console.log("Service Worker initializing...");chrome.runtime.onInstalled.addListener(async()=>{console.log("Extension installed/updated."),await v(),chrome.alarms.create("popCheck",{periodInMinutes:1})});chrome.alarms.onAlarm.addListener(e=>{e.name==="popCheck"&&k()});chrome.runtime.onMessage.addListener((e,a,t)=>(T(e,t),!0));async function T(e,a){try{switch(e.action){case"getSnoozedTabs":a(await g());break;case"setSnoozedTabs":await w(e.data),a({success:!0});break;case"getSettings":a(await p());break;case"setSettings":await h(e.data),a({success:!0});break;case"snooze":await y(e.tab,e.popTime,e.openInNewWindow),a({success:!0});break;case"removeSnoozedTab":await S(e.tab),a({success:!0});break;default:console.warn("Unknown message action:",e.action),a({error:"Unknown action"})}}catch(t){console.error("Error handling message:",t),a({error:t.message})}}async function v(){let e=await g();e||(e={tabCount:0},await w(e));let a=await p();a||(a={"start-day":"9:00 AM","end-day":"6:00 PM","start-weekend":"10:00 AM","week-begin":1,"weekend-begin":6,"later-today":3,someday:3,"open-new-tab":"true",badge:"true"},await h(a)),await chrome.action.setBadgeBackgroundColor({color:"#FED23B"}),await chrome.action.setBadgeBackgroundColor({color:"#FED23B"})}async function y(e,a,t){const o=new Date(a);try{await chrome.tabs.remove(e.id)}catch(n){console.warn("Could not close tab (maybe already closed):",n)}await b(e,o,t)}async function k(){if(!navigator.onLine){console.log("Offline, skipping popCheck.");return}const e=await new Promise(r=>chrome.notifications.getAll(r));if(Object.keys(e).length>0){console.log("Notifications active, skipping popCheck.");return}const a=await g();if(a){for(var t=Object.keys(a).sort(),o=[],n=[],s=Date.now(),i=0;i<t.length;i++){var l=t[i];if(l!=="tabCount"){var c=parseInt(l);isNaN(c)||c<s&&(n.push(l),o=o.concat(a[l]))}}o.length>0&&C(o,async r=>{await chrome.storage.local.set({pendingTabs:{tabs:o,times:n,notificationId:r}})})}}function C(e,a){var t=e.length,o=""+t+(t>1?" tabs are back":" tab is back");chrome.notifications.create("",{type:"basic",priority:1,title:"Snooooze",message:o,iconUrl:"assets/icons/browserAction.png",buttons:[{title:"Open Now"},{title:"Postpone all but 50"}]},function(n){a(n)})}chrome.notifications.onClosed.addListener(async(e,a)=>{const t=await chrome.storage.local.get("pendingTabs");if(t.pendingTabs&&t.pendingTabs.notificationId===e){console.log("Notification closed. Re-snoozing for 1 hour.");const o=t.pendingTabs.tabs;for(const n of o){const s=new Date;s.setHours(s.getHours()+1),await f(n,s)}await chrome.storage.local.remove("pendingTabs")}});chrome.notifications.onButtonClicked.addListener(async(e,a)=>{const t=await chrome.storage.local.get(["pendingTabs","settings"]);if(t.pendingTabs&&t.pendingTabs.notificationId===e){const i=t.pendingTabs.tabs,l=t.pendingTabs.times;if(a===0){var o=t.settings||{},n=o["open-new-tab"]==="true"||o["open-new-tab"]===!0;if(n){const r=await chrome.windows.getCurrent();await m(i,r)}else{const r=await chrome.windows.create({});await m(i,r)}const c=await g();for(var s=0;s<l.length;s++)delete c[l[s]];c.tabCount=Math.max(0,c.tabCount-i.length),await w(c)}else if(a===1){console.log("Postponing...");for(const c of i){const r=new Date;r.setHours(r.getHours()+1),await f(c,r)}}await chrome.storage.local.remove("pendingTabs"),chrome.notifications.clear(e)}});async function m(e,a){for(var t=0;t<e.length;t++)await z(e[t],a)}async function z(e,a){try{await chrome.tabs.create({windowId:a.id,url:e.url,active:!1})}catch(t){console.error(t)}}let d=Promise.resolve();async function b(e,a,t){return d=d.then(async()=>{const o=await g(),n=a.getTime();o[n]||(o[n]=[]),o[n].push({url:e.url,title:e.title,favicon:e.favIconUrl||e.favicon,creationTime:new Date().getTime(),popTime:a.getTime(),openInNewWindow:!!t}),o.tabCount=(o.tabCount||0)+1,await w(o)}).catch(o=>{console.error("Error in storage lock:",o)}),d}async function S(e){const a=await g();await u(e,a),await w(a)}async function u(e,a){var t=new Date(e.popTime).getTime(),o=a[t];if(o){for(var n=-1,s=new Date(e.creationTime).getTime(),i=0;i<o.length;i++)if(new Date(o[i].creationTime).getTime()===s){n=i;break}n<0||(o.splice(n,1),o.length==0?delete a[t]:a[t]=o,a.tabCount=Math.max(0,a.tabCount-1))}}async function f(e,a){const t=await g();await u(e,t),await w(t),await b(e,a,e.openInNewWindow)}async function g(){return(await chrome.storage.local.get("snoozedTabs")).snoozedTabs}async function w(e){await chrome.storage.local.set({snoozedTabs:e})}async function p(){return(await chrome.storage.local.get("settings")).settings}async function h(e){await chrome.storage.local.set({settings:e})}
