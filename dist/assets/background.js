chrome.runtime.onInstalled.addListener(async()=>{await f(),chrome.alarms.create("popCheck",{periodInMinutes:1}),setTimeout(()=>l(),1e3)});chrome.runtime.onStartup.addListener(()=>{setTimeout(()=>l(),1e3)});chrome.alarms.onAlarm.addListener(e=>{e.name==="popCheck"&&l()});chrome.runtime.onMessage.addListener((e,a,t)=>(b(e,t),!0));async function b(e,a){try{switch(e.action){case"getSnoozedTabs":a(await s());break;case"setSnoozedTabs":await c(e.data),a({success:!0});break;case"getSettings":a(await m());break;case"setSettings":await g(e.data),a({success:!0});break;case"snooze":await h(e.tab,e.popTime,e.openInNewWindow),a({success:!0});break;case"removeSnoozedTab":await y(e.tab),a({success:!0});break;case"clearAllSnoozedTabs":await c({tabCount:0}),a({success:!0});break;default:a({error:"Unknown action"})}}catch(t){a({error:t.message})}}async function f(){let e=await s();e||(e={tabCount:0},await c(e));let a=await m();a||(a={"start-day":"9:00 AM","end-day":"6:00 PM","start-weekend":"10:00 AM","week-begin":1,"weekend-begin":6,"later-today":3,someday:3,"open-new-tab":"true",badge:"true"},await g(a)),await chrome.action.setBadgeBackgroundColor({color:"#FED23B"}),await chrome.action.setBadgeBackgroundColor({color:"#FED23B"})}async function h(e,a,t){const n=new Date(a);try{await chrome.tabs.remove(e.id)}catch{}await p(e,n,t)}async function l(){if(!navigator.onLine)return 0;const e=await s();if(!e)return 0;for(var a=Object.keys(e).sort(),t=[],n=[],o=Date.now(),i=0;i<a.length;i++){var r=a[i];if(r!=="tabCount"){var w=parseInt(r);isNaN(w)||w<o&&(n.push(r),t=t.concat(e[r]))}}return t.length>0&&await T(t,n),{count:t.length}}async function T(e,a){var t=await m(),n=t["open-new-tab"]==="true"||t["open-new-tab"]===!0;if(n){const r=await chrome.windows.getCurrent();await d(e,r)}else{const r=await chrome.windows.create({});await d(e,r)}const o=await s();if(o){for(var i=0;i<a.length;i++)delete o[a[i]];o.tabCount=Math.max(0,o.tabCount-e.length),await c(o)}}async function d(e,a){for(var t=0;t<e.length;t++)await v(e[t],a)}async function v(e,a){try{await chrome.tabs.create({windowId:a.id,url:e.url,active:!1})}catch{}}let u=Promise.resolve();async function p(e,a,t){return u=u.then(async()=>{const n=await s(),o=a.getTime();n[o]||(n[o]=[]),n[o].push({url:e.url,title:e.title,favicon:e.favIconUrl||e.favicon,creationTime:new Date().getTime(),popTime:a.getTime(),openInNewWindow:!!t}),n.tabCount=(n.tabCount||0)+1,await c(n)}).catch(n=>{}),u}async function y(e){const a=await s();await k(e,a),await c(a)}async function k(e,a){var t=new Date(e.popTime).getTime(),n=a[t];if(n){for(var o=-1,i=new Date(e.creationTime).getTime(),r=0;r<n.length;r++)if(new Date(n[r].creationTime).getTime()===i){o=r;break}o<0||(n.splice(o,1),n.length==0?delete a[t]:a[t]=n,a.tabCount=Math.max(0,a.tabCount-1))}}async function s(){return(await chrome.storage.local.get("snoozedTabs")).snoozedTabs}async function c(e){await chrome.storage.local.set({snoozedTabs:e})}async function m(){return(await chrome.storage.local.get("settings")).settings}async function g(e){await chrome.storage.local.set({settings:e})}
